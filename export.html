<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Export | bench & berg</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" ></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.14.1/xlsx.full.min.js"></script>
    <script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="loading">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div class="text-center">
    <h1>bench <br>& berg</h1>
</div>
<div class="tableFixHead mt-20">
    <table class="table table-bordered" id="excel-table">
        <thead id="theadHtml">
        <tr>
            <th>#</th>
            <th>CODE B&B</th>
            <th>NOM</th>
            <th>CATEGORIE</th>
            <th>COULEUR</th>
            <th>PIEDS</th>
        </tr>
        </thead>
        <tbody id="tbodyHtml">

        </tbody>
    </table>
</div>
<div class="bottomButtons text-center" style="display:none;">
    <center>
        <p id="bigText"></p>
        <a href="filter"><button class="btn btn-flat btn-lg bg-orange">EDITER LA SÉLECTION</button></a>
        <button onclick="exportEXCEL()" class="btn btn-flat btn-lg bg-green">TÉLÉCHARGER LE FICHIER D'OFFRE</button>
    </center>
</div>
<script>
    $('.loading').show();
    var dbName=localStorage.getItem("myFilteredData");
    console.log('----------------------------------------------');
    console.log(dbName);
    if(dbName == ""){
        alert('please upload a file again, its not having data in Indexdb to export.');
    }
    else{
        var openRequest = indexedDB.open(dbName,1);
        openRequest.onsuccess = function(e) {
            console.log("running on success");

            db = e.target.result;
            var objectStore = db.transaction(dbName).objectStore(dbName);

            objectStore.openCursor().onsuccess = function(event) {
                var cursor = event.target.result;

                if (cursor) {
                    var countOfRows=0;
                    $.each(cursor.value, function (index,subArray) {
                        tbodyHtml+="<tr>";
                        tbodyHtml+="<td>"+parseInt(index+1)+"</td>";
                        // for (var key in subArray) {
                        tbodyHtml += '<td>'+subArray['code_b_b']+'</td>';
                        tbodyHtml += '<td>'+subArray['nom']+'</td>';
                        tbodyHtml += '<td>'+subArray['category']+'</td>';
                        tbodyHtml += '<td>'+subArray['couleur']+'</td>';
                        tbodyHtml += '<td>'+subArray['pied']+'</td>';
                        // }
                        tbodyHtml+="</tr>";
                        countOfRows++;
                    });
                    $('#tbodyHtml').html(tbodyHtml);
                    $('#bigText').html('Vous avez sélectionne <b>'+countOfRows+'</b> produits');
                    $('.bottomButtons').show();
                    $('.loading').hide();
                    cursor.continue();
                } else {
                }
            };
        }
    }
</script>
<script>
    function exportEXCEL() {
        var wb = XLSX.utils.table_to_book(document.getElementById('excel-table'), {sheet:"Sheet JS"});
        var wbout = XLSX.write(wb, {bookType:'xlsx', bookSST:true, type: 'binary'});
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!

        var yyyy = today.getFullYear();
        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        var today = dd + mm + yyyy;
        saveAs(new Blob([s2ab(wbout)], {type: "application/octet-stream"}), 'B&B_ficher_offre_'+today+'_XXX.xlsx');
    }

    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

</script>
</body>
</html>