<!DOCTYPE html>
<html lang=  "en">
<head>
    <meta charset="UTF-8">
    <title>Filter | bench & berg</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .bottomButtons{
            margin-bottom: 100px;
        }
        .BtnBagrd{
            padding: 0;
            background-color: #ebebeb;
        }
        .nomDiv{
            margin-bottom: 30px;background-color: #ebebeb;padding: 30px;
        }
        .DuplicateRows{
            background-color: #f3f3f3;
            margin-bottom: 30px;
        }
        .btn-danger{
            font-size: x-large;
            padding: 5px 15px;
        }
        .btn-clear{
            font-weight: bold;
            font-size: x-large;
            padding: 5px 20px;
            border: 1px solid lightgray;
        }
        table, th, td {
            background: #F5F5F5;
        }
        .Btnhidden{
            display: none;
        }
        td {
            border: 1px solid black;
            border-collapse: unset;
        }

        table {
            border: 1px solid white;
            border-collapse: unset;
        }

        #tbodyHtml > tr > td {
            border: 1px solid #dee2e6;
            background: white;
        }

        .tableFixHead > .tableresult {
            background: white;
            border-collapse: collapse;
        }

        .btn-filter {
            margin: 2px;
        }
        .center-align{
            align-items: center;
            justify-content: center;
            display: flex;
        }
        #filterContent{
            background: #f5f5f503;
            border: none !important;
        }
        .FilterTd{
            background: #f5f5f503;
            border: none !important;
            padding: 0px 5px;
        }
        .filter{
            background-color: white;
            height: 150px;
            overflow: auto;
        }
        .modal-header{
            background-color: #dedcde;
            padding: 5px;
        }
        .sort{
            background-color: #eceff163;
            border: 1px solid;
            border-radius: 5px;
            display: flex;  padding: 0 8px;
        }
        .caretBtn{
            float: right;
            border: none;
            background: transparent;
        }
        hr{
            border-top: 1px solid #c7c6c6;
            margin-top: 40px;
        }
        .div {
            border: 1px solid black;
            padding: 10px;
            margin: 10px;
            margin-top: 20px;
        }

        .title {
            width: 127px;
            margin-top: -20px;
            margin-left: 5px;
            background: white;
            text-align: center;
        }

        .mainBlock {
            padding: 20px;
            margin: 10px;
        }

        .unselectedBlock {
            padding: 20px;
            background-color: #f3f3f3;
        }

        .selectedBlockContainer {
            padding: 20px;
        }
        .selectedBlock{
            padding: 0 20px;
        }
        .vertical_text{
            writing-mode: tb-rl;
            text-orientation: upright;
            font-size: 9px; font-weight: bold;
        }
        .FinalCount{position: fixed;bottom: 0;background-color: white;padding: 30px;font-size: x-large;}
    </style>
</head>
<body>
<div class="loading">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div class="text-center" id="marqueName">
    <h1>bench <br>& berg</h1>
</div>
<div class="row mainBlock">

</div>
<div class="container-fluid" style="background: #adb5bd;display:none;">
    <h5>First Selection</h5>
    <div class="row">
        <div class="col-md-2">
            <table>
                <thead>
                <tr>
                    <th>MODELE</th>
                </tr>
                </thead>
                <tbody id="nomFilter"></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <table>
                <thead>
                <tr>
                    <th colspan="2">CATEGORIE</th>
                </tr>
                </thead>
                <tbody id="categoryFilter"></tbody>
            </table>

        </div>
        <div class="col-md-4">
            <table>
                <thead>
                <tr>
                    <th colspan="2">COULEUR</th>
                </tr>
                </thead>
                <tbody id="couleurFilter"></tbody>
            </table>
        </div>
        <div class="col-md-2">
            <table>
                <thead>
                <tr>
                    <th>COULEUR PIEDS</th>
                </tr>
                </thead>
                <tbody id="piedsFilter"></tbody>
            </table>
        </div>
    </div>
    <br>
</div>

<div class="tableFixHead mt-20 hidden">
    <table class="table table-bordered tableresult" id="myTable">
        <thead id="theadHtml">
        <tr>
            <th>#</th>
            <th>CODE B&B <button type="button" class="caretBtn" data-toggle="modal" data-target="#filterModal" onclick="setFilterContent('code_b_b')"><i class="fa fa-caret-down"></i></button></th>
            <th>NOM <button type="button" class="caretBtn" data-toggle="modal" data-target="#filterModal" onclick="setFilterContent('nom')"><i class="fa fa-caret-down"></i></button></th>
            <th>CATEGORIE <button type="button" class="caretBtn" data-toggle="modal" data-target="#filterModal" onclick="setFilterContent('category')"><i class="fa fa-caret-down"></i></button></th>
            <th>COULEUR <button type="button" class="caretBtn" data-toggle="modal" data-target="#filterModal" onclick="setFilterContent('couleur')"><i class="fa fa-caret-down"></i></button></th>
            <th>PIEDS <button type="button" class="caretBtn" data-toggle="modal" data-target="#filterModal" onclick="setFilterContent('pied')"><i class="fa fa-caret-down"></i></button></th>
        </tr>
        </thead>
        <tbody id="tbodyHtml">

        </tbody>
    </table>
    <div class="modal fade" id="filterModal" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content" style="background-color: #ececec;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="col-md-12 center-align">
                        <div class="col-md-8">
                            <b>Sort</b><br>
                            <input type="hidden" value="" id="ContentType">
                            <button type="button" class="sort pull-left" onclick="SortAsc();"><span class="vertical_text">AZ </span><i style="margin: auto;" class="fa fa-long-arrow-down"></i><span> &ensp;Ascending</span></button>
                            <button type="button" class="sort pull-right" onclick="SortDsc();"><span class="vertical_text">ZA </span><i style="margin: auto;" class="fa fa-long-arrow-down"></i><span> &ensp;Descending</span></button>
                            <hr>
                            <!--<input type="text" placeholder="&#xF002; Search" name="search" id="search">-->
                            <!--<hr style="margin-top: 10px">-->
                            <b>Filter</b><br>
                            <div class="filter">
                                <table id="filterContent">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="bottomButtons text-center">
    <center>
        <a href="upload">
            <button class="btn btn-flat btn-lg bg-orange">GO TO UPLOAD</button>
        </a>
        <a href="export">
            <button class="btn btn-flat btn-lg bg-green">GO TO EXPORT</button>
        </a>
    </center>
</div>
<div class="col-md-12 FinalCount">
    <span id="FinalCount"></span>
</div>
</body>
</html>
<script>
    $('.loading').show();
    var dbName = localStorage.getItem("myDbName");
    var filteredDbName = localStorage.getItem("myFilteredData");
    var db;
    var db1;
    var allData = [];
    var filteredData = [];
    var filteredData1 = [];
    var htmlCounter = 1;
    var allNom = [];
    var allColor = [];
    var allCategory = [];
    var allPied = [];
    var filteredColor = [];
    var filteredCategory = [];
    var filteredPied = [];
    var filteredNom = [];
    //=================================
    var fd = [];

    if (dbName == "") {
        alert('please upload a file again, its not having data in Indexdb to filter.');
    }
    else {
        var openRequest = indexedDB.open(dbName, 1);
        openRequest.onsuccess = function (e) {
            console.log("running onsuccess");
            db = e.target.result;
            var objectStore = db.transaction(dbName).objectStore(dbName);
            objectStore.openCursor().onsuccess = function (event) {
                var cursor = event.target.result;
                if (cursor) {
                    allData = cursor.value;
                    filteredData = allData;
                    filteredData1 = allData;
                    allNom = _.uniq(allData, function (arrray) {
                        return arrray.nom.trim();
                    });
                    marque = _.uniq(allData, function (arrray) {
                        return arrray.marque.trim();
                    });
                    $.each(allNom, function (index,nom1){
                        var nom= nom1.nom;
                        fd[nom] = [];
                        fd[nom]['allData']          = _.where(allData, {nom: nom});
                        fd[nom]['tissuVal']         = [];
                        fd[nom]['allPied']          = [];
                        fd[nom]['allCategory']      = [];
                        fd[nom]['tissu']            = [];
                        fd[nom]['allDataCount']     = _.size(_.where(allData, {nom: nom}));
                        fd[nom]['tissuVal'] = _.uniq(_.where(allData, {nom: nom}), function (arrray) {
                            return arrray.tissu.trim();
                        });
                        fd[nom]['allColors'] = _.uniq(_.where(allData, {nom: nom}), function (arrray) {
                            return arrray.couleur.trim();
                        });
                        fd[nom]['allTissu'] = _.uniq(_.where(allData, {nom: nom}), function (arrray) {
                            return arrray.tissu.trim();
                        });

                        fd[nom]['allPied'] = _.uniq(_.where(allData, {nom: nom}), function (arrray) {
                            return arrray.pied.trim();
                        });
                        fd[nom]['allCategory'] = _.uniq(_.where(allData, {nom: nom}), function (arrray) {
                            return arrray.category.trim();
                        }) ;
                        fd[nom]['sfilteredData']             = [];
                        fd[nom]['sfilteredColor']            = [];
                        fd[nom]['sfilteredPied']             = [];
                        fd[nom]['sfilteredCategory']         = [];
                        fd[nom]['sfilteredDataCount']        = 0;
                        fd[nom]['ufilteredData']             = [];
                        fd[nom]['ufilteredColor']            = [];
                        fd[nom]['ufilteredTissu']            = [];
                        fd[nom]['ufilteredPied']             = [];
                        fd[nom]['ufilteredCategory']         = [];
                        fd[nom]['ufilteredDataCount']        = [];
                        fd[nom]['ufilteredData'][0]          = fd[nom]['allData'];
                        fd[nom]['ufilteredColor'][0]         = fd[nom]['allColors'];
                        fd[nom]['ufilteredTissu'][0]         = fd[nom]['allTissu'];
                        fd[nom]['ufilteredPied'][0]          = fd[nom]['allPied'];
                        fd[nom]['ufilteredCategory'][0]      = fd[nom]['allCategory'];
                        fd[nom]['ufilteredDataCount'][0]     = fd[nom]['allDataCount'];
                    });
                    $.each(marque, function (index, marq) {
                        if (marq.marque != "") {
                            $('#marqueName').html('<h1>' + marq.marque + '</h1>');
                        }
                    });
                    filterHtml();
                    tableHtml();
                    $('.loading').hide();
                    cursor.continue();
                } else {
                }
            };
        }
    }
    function filterHtml() {
        var html='';
        $.each(allNom, function (index,nom1){
            var TissHtml = '';
            var TissHtml1 = '';
            var colorHtml = '';
            var colorHtml1 = '';
            var piedsHtml = '';
            var categoryHtml = '';
            var piedsHtml1 = '';
            var categoryHtml1 = '';
            var nom = nom1.nom;
            var ucount = fd[nom]['ufilteredDataCount'][0];
            var scount = fd[nom]['sfilteredDataCount'];
            $.each(fd[nom]['allColors'], function (index, data) {
                if(data.couleur != "") {
                    if (_.size(_.where(fd[nom]['ufilteredColor'][0], data)) > 0) {
                        colorHtml += '<button class="btn btn-primary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="couleur" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.couleur + '">' + data.couleur + '</button>';
                    }
                    else {
                        colorHtml += '<button class="btn btn-secondary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="couleur" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.couleur + '">' + data.couleur + '</button>';
                    }
                    if (_.size(_.where(fd[nom]['sfilteredPied'], data)) > 0) {
                        colorHtml1 += '<button class="btn btn-primary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="couleur" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.couleur + '">' + data.couleur + '</button>';
                    }
                    else{
                        colorHtml1 += '<button class="btn btn-secondary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="couleur" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.couleur + '">' + data.couleur + '</button>';
                    }
                }
            });
            $.each(fd[nom]['allTissu'], function (index, data) {
                if(data.tissu != "") {
                    if (_.size(_.where(fd[nom]['ufilteredTissu'][0], data)) > 0) {
                        TissHtml += '<button class="btn btn-primary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="tissu" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.tissu + '">' + data.tissu + '</button>';
                    }
                    else {
                        TissHtml += '<button class="btn btn-secondary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="tissu" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.tissu + '">' + data.tissu + '</button>';
                    }
                    if (_.size(_.where(fd[nom]['sfilteredPied'], data)) > 0) {
                        TissHtml1 += '<button class="btn btn-primary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="tissu" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.tissu + '">' + data.tissu + '</button>';
                    }
                    else{
                        TissHtml1 += '<button class="btn btn-secondary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="tissu" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.tissu + '">' + data.tissu + '</button>';
                    }
                }
            });
            $.each(fd[nom]['allPied'], function (index, data) {
                if(data.pied != "") {
                    if (_.size(_.where(fd[nom]['ufilteredPied'][0], data)) > 0) {
                        piedsHtml += '<button class="btn btn-primary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="pied" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.pied + '">' + data.pied + '</button>';
                    }
                    else {
                        piedsHtml += '<button class="btn btn-secondary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="pied" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.pied + '">' + data.pied + '</button>';
                    }
                    if (_.size(_.where(fd[nom]['sfilteredPied'], data)) > 0) {
                        piedsHtml1 += '<button class="btn btn-primary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="pied" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.pied + '">' + data.pied + '</button>';
                    }
                    else{
                        piedsHtml1 += '<button class="btn btn-secondary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="pied" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.pied + '">' + data.pied + '</button>';
                    }
                }
            });
            $.each(fd[nom]['allCategory'], function (index, data) {
                if(data.category != "") {
                    if (_.size(_.where(fd[nom]['ufilteredCategory'][0], data)) > 0) {
                        categoryHtml += '<button class="btn btn-primary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="category" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.category + '">' + data.category + '</button>';
                    }
                    else{
                        categoryHtml += '<button class="btn btn-secondary btn-filter btn-unselected" data-block-id="'+data.nom+'-0" data-filter-type="category" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.category + '">' + data.category + '</button>';
                    }
                    if (_.size(_.where(fd[nom]['sfilteredCategory'], data)) > 0) {
                        categoryHtml1 += '<button class="btn btn-primary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="category" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.category + '">' + data.category + '</button>';
                    }
                    else{
                        categoryHtml1 += '<button class="btn btn-secondary btn-filter btn-selected" data-block-id="'+data.nom+'-0" data-filter-type="category" data-filter-nom="' + data.nom + '"  data-filter-value="' + data.category + '">' + data.category + '</button>';
                    }
                }
            });
            var nomHTml='<div class="col-12 nomDiv">' +
                '                <div class="col-md-12"><center><h3>'+nom.replace(/_/g, ' ')+'</h3></center></div>' +
                '                <div class="col-md-12"><h6 class="text-right">Produits sélectionnés: <b class="selectedCount" datablockno="'+nom+'-0" id="unselected-'+nom+'">'+ucount+'</b></h6></div>' +
                '                <div class="row unselectedBlock">' +
                '                <div class="col-12" style="padding: 0;"><button class="btn btn-sm btn-clear unselect-block pull-right" type="button">x</button></div>' +
                '                   <div class="col-md-12" style="display: contents">' +
                '                       <div class="col-12">' +
                '                           <h6>Couleur</h6>' +
                '                           <div class="col-12">' +
                '                               ' +colorHtml+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-12">' +
                '                           <h6>Categorie</h6>' +
                '                           <div class="col-12">' +
                '                           ' +categoryHtml+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-6">' +
                '                           <h6>Toucher</h6>' +
                '                           <div class="col-12">' +
                '                           ' +TissHtml+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-6">' +
                '                           <h6>Couleur Pieds</h6>' +
                '                           <div class="col-12">' +
                '                               ' +piedsHtml+
                '                           </div>' +
                '                       </div>' +
                '                   </div>' +
                '               </div>' +
                '               <div class="row selectedBlockContainer">' +
                '                   <div class="col-12">' +
                '                      <div class="row selectedBlock"> </div>' +
                '                   </div>' +
                '                   <div class="row selectedBlock-copy" style="display: none;">' +
                '                    <div class="col-md-12 BtnBagrd"><p class="text-right">Produits sélectionnés: <b class="selectedCount" id="selected-'+nom+'">'+scount+'</b></p></div>' +
                '                    <div class="col-md-6"><br><button class="btn btn-sm btn-danger btn-one-more-div-close" style="float: right;">-</button></div>' +
                '                     <div class="col-md-6"><br><button class="btn btn-sm btn-clear btn-unselect-duplicate-1 pull-right" type="button">x</button></div>' +
                '                       <div class="col-12">' +
                '                           <h6>Couleur</h6>' +
                '                           <div class="col-12">' +
                '                               ' +colorHtml1+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-12">' +
                '                           <h6>Categorie</h6>' +
                '                           <div class="col-12">' +
                '                           ' +categoryHtml1+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-6">' +
                '                           <h6>Toucher</h6>' +
                '                           <div class="col-12">' +
                '                           ' +TissHtml1+
                '                           </div>' +
                '                       </div>' +
                '                       <div class="col-6">' +
                '                           <h6>Couleur Pieds</h6>' +
                '                           <div class="col-12">' +
                '                               ' +piedsHtml1+
                '                           </div>' +
                '                       </div>' +
                '                    </div>' +
                '                   <div class="col-md-6" style="margin-bottom: 30px;">' +
                '                       <button class="btn btn-sm btn-danger btn-one-more-div pull-right">+</button>' +
                '                   </div>' +
                '            </div>' +
                '        </div>';
            html += nomHTml;
        });
        $('.mainBlock').append(html);
    }

    $(document).on('click','.btn-one-more-div',function(){
        var htmlString = "";
        var DivName = 'Duplicate-div-'+htmlCounter;
        htmlString += '<div class="row DuplicateRows" id="Duplicate-div-'+htmlCounter+'">';
        htmlString += $(this).closest('.selectedBlockContainer').find('.selectedBlock-copy').html();
        htmlString += '</div>';
        $(this).closest('.selectedBlockContainer').find('.selectedBlock').append(htmlString);
        $(this).closest('.selectedBlockContainer').find('.selectedBlock').find('#'+DivName).find('.btn-unselect-duplicate-1').data('id',htmlCounter);
        $(this).closest('.selectedBlockContainer').find('.selectedBlock').find('#'+DivName).find('.btn-one-more-div-close').attr('id',htmlCounter);
        $(this).attr('id',htmlCounter);
        $('#Duplicate-div-'+htmlCounter).find(".btn").attr('data-block-id',htmlCounter);
        $('#Duplicate-div-'+htmlCounter).find(".selectedCount").attr('datablockno',htmlCounter);
        htmlCounter++;
    });
    $(document).on('click','.btn-one-more-div-close',function(){
        $('#Duplicate-div-'+$(this).attr('id')).remove();
        $(this).removeClass('btn-one-more-div-close');
        $(this).addClass('btn-one-more-div');
        $(this).html('+');
    });

    // For Unselecting more Duplicate Entries
    $(document).on('click','.btn-unselect-duplicate-1',function(){
        var DivName = 'Duplicate-div-'+$(this).data('id');
        var filterNom = $(this).closest('.selectedBlockContainer').find('#'+DivName).find('.btn-primary').attr('data-filter-nom');
        $(this).closest('.selectedBlockContainer').find('#'+DivName).find('.btn-selected').removeClass('btn-primary');
        $(this).closest('.selectedBlockContainer').find('#'+DivName).find('.btn-selected').addClass('btn-secondary');
        fd[filterNom]['sfilteredData']        = [];
        fd[filterNom]['sfilteredDataCount']   = 0;
        $(this).closest('.selectedBlockContainer').find('#'+DivName).find('#selected-'+filterNom).html(0);
        tableHtml();
    });

    // For unselecting the selected div
    $(document).on('click','.unselect-block',function(){
        var filterNom = $(this).closest('.unselectedBlock').find('.btn-unselected').attr('data-filter-nom');
        $(this).closest('.unselectedBlock').find('.btn-unselected').removeClass('btn-primary');
        $(this).closest('.unselectedBlock').find('.btn-unselected').addClass('btn-secondary');
		  $(this).closest('.unselectedBlock').find('.btn-unselected').addClass('btn-primary');
        fd[filterNom]['ufilteredData'][0]        = [];
        fd[filterNom]['ufilteredDataCount'][0] = "";
        $('#unselected-'+filterNom).html(0);

        tableHtml();
    });

    function tableHtml() {
        var tbodyHtml = "";
        var countOfRows=0;
        var fNewData = [];
        $.each(allNom, function (index,thisNom){
            var filterNom = thisNom.nom;
            if($(this).hasClass('btn-selected')) {
                if ($('.btn-selected.btn-primary[data-filter-type="couleur"][data-filter-nom="' + filterNom + '"]').length !== 0 &&
                    $('.btn-selected.btn-primary[data-filter-type="category"][data-filter-nom="' + filterNom + '"]').length !== 0 &&
                    $('.btn-selected.btn-primary[data-filter-type="tissu"][data-filter-nom="' + filterNom + '"]').length !== 0 &&
                    $('.btn-selected.btn-primary[data-filter-type="pied"][data-filter-nom="' + filterNom + '"]').length !== 0) {
                    $('.btn-selected.btn-primary[data-filter-nom="' + filterNom + '"]').each(function () {
                        var filterTypeInner = $(this).attr('data-filter-type');
                        var filterValInner = $(this).attr('data-filter-value');
                        var filterNomInner = $(this).attr('data-filter-nom');
                        var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                        fNewData = _.union(fNewData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                            return item;
                        });
                    });
                } else {
                    $('.btn-selected.btn-primary[data-filter-nom="' + filterNom + '"]').each(function () {
                        var filterTypeInner = $(this).attr('data-filter-type');
                        var filterValInner = $(this).attr('data-filter-value');
                        var filterNomInner = $(this).attr('data-filter-nom');
                        var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                        fNewData = _.union(fNewData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                            return item.nom != filterNomInner;
                        });
                    });
                }
            }else{
                $('.btn-unselected.btn-primary[data-filter-nom="' + filterNom + '"]').each(function () {
                    var filterTypeInner = $(this).attr('data-filter-type');
                    var filterValInner = $(this).attr('data-filter-value');
                    var filterNomInner = $(this).attr('data-filter-nom');
                    var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                    fNewData = _.union(fNewData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                        return item;
                    });
                });
            }
        });

        var myDbName = 'myFilteredData';
        var r = Math.random().toString(36).substring(7);
        myDbName = myDbName + '-' + r;
        localStorage.setItem("myFilteredData", myDbName);
        createMyDatabase(myDbName, fNewData);

        $.each(fNewData, function (index, subArray) {
            tbodyHtml += "<tr>";
            tbodyHtml += "<td>" + parseInt(index + 1) + "</td>";
            tbodyHtml += '<td>' + subArray['code_b_b'] + '</td>';
            tbodyHtml += '<td>' + subArray['nom'] + '</td>';
            tbodyHtml += '<td>' + subArray['category'] + '</td>';
            tbodyHtml += '<td>' + subArray['couleur'] + '</td>';
            tbodyHtml += '<td>' + subArray['pied'] + '</td>';
            tbodyHtml += "</tr>";
            countOfRows++;
        });
        $('#tbodyHtml').html(tbodyHtml);
        $('#FinalCount').html('<b> TOTAL produits sélectionnes: '+countOfRows+'</b>');
    }

    function tableHtml1() {
        var myDbName = 'myFilteredData';
        var countData = [];
        var r = Math.random().toString(36).substring(7);
        myDbName = myDbName + '-' + r;
        localStorage.setItem("myFilteredData", myDbName);
        createMyDatabase(myDbName, filteredData);

        var tbodyHtml = "";
        var countOfRows=0;
        $.each(filteredData1, function (index, subArray) {
            tbodyHtml += "<tr>";
            tbodyHtml += "<td>" + parseInt(index + 1) + "</td>";
            tbodyHtml += '<td>' + subArray['code_b_b'] + '</td>';
            tbodyHtml += '<td>' + subArray['nom'] + '</td>';
            tbodyHtml += '<td>' + subArray['category'] + '</td>';
            tbodyHtml += '<td>' + subArray['couleur'] + '</td>';
            tbodyHtml += '<td>' + subArray['pied'] + '</td>';
            tbodyHtml += "</tr>";
            countOfRows++;
        });
        $('#tbodyHtml').html(tbodyHtml);
        $('#FinalCount').html('<b> TOTAL produits sélectionnes: '+countOfRows+'</b>');
    }

    $(document).on('click', '.btn-filter', function () {
        var filterNom = $(this).attr('data-filter-nom');
        var filterBlockId = $(this).attr('data-block-id');
        if($(this).hasClass('btn-primary')){
            $(this).removeClass('btn-primary');
            $(this).addClass('btn-secondary');
        }
        else{
            $(this).removeClass('btn-secondary');
            $(this).addClass('btn-primary');
        }
        var fBlockedData = [];
        if($(this).hasClass('btn-unselected')) {
                $('.btn-unselected.btn-primary[data-block-id="' + filterBlockId + '"]').each(function () {
                    var filterTypeInner = $(this).attr('data-filter-type');
                    var filterValInner = $(this).attr('data-filter-value');
                    var filterNomInner = $(this).attr('data-filter-nom');
                    var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                    fBlockedData = _.union(fBlockedData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                        return item;
                    });
                });
                $('b[datablockno="' + filterBlockId + '"]').html(_.size(fBlockedData));
        }else{
            if ($('.btn-selected.btn-primary[data-filter-type="couleur"][data-filter-nom="' + filterNom + '"][data-block-id="' + filterBlockId + '"]').length !== 0 &&
                $('.btn-selected.btn-primary[data-filter-type="category"][data-filter-nom="' + filterNom + '"][data-block-id="' + filterBlockId + '"]').length !== 0 &&
                $('.btn-selected.btn-primary[data-filter-type="tissu"][data-filter-nom="' + filterNom + '"][data-block-id="' + filterBlockId + '"]').length !== 0 &&
                $('.btn-selected.btn-primary[data-filter-type="pied"][data-filter-nom="' + filterNom + '"][data-block-id="' + filterBlockId + '"]').length !== 0) {
                $('.btn-selected.btn-primary[data-block-id="' + filterBlockId + '"]').each(function () {
                    var filterTypeInner = $(this).attr('data-filter-type');
                    var filterValInner = $(this).attr('data-filter-value');
                    var filterNomInner = $(this).attr('data-filter-nom');
                    var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                    fBlockedData = _.union(fBlockedData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                        return item;
                    });
                });
                $('b[datablockno="' + filterBlockId + '"]').html(_.size(fBlockedData));
            } else {
                $('.btn-selected.btn-primary[data-block-id="' + filterBlockId + '"]').each(function () {
                    var filterTypeInner = $(this).attr('data-filter-type');
                    var filterValInner = $(this).attr('data-filter-value');
                    var filterNomInner = $(this).attr('data-filter-nom');
                    var filterCondition = '{"nom": "' + filterNomInner + '","' + filterTypeInner + '":"' + filterValInner + '"}';
                    fBlockedData = _.union(fBlockedData, _.filter(_.where(allData, JSON.parse(filterCondition))), function (item) {
                        // return item;
                        return item.nom != filterNomInner;
                    });
                });
                // $('b[datablockno="' + filterBlockId + '"]').html(_.size(fBlockedData));
                $('b[datablockno="' + filterBlockId + '"]').html(0);
            }
        }
        tableHtml();
    });

    var db;
    function indexedDBOk() {
        return "indexedDB" in window;
    }

    function createMyDatabase(db_name, jsonData) {
        //No support? Go in the corner and pout.
        if (!indexedDBOk) return;

        var openRequest = indexedDB.open(db_name, 1);

        openRequest.onupgradeneeded = function (e) {
            var thisDB = e.target.result;

            if (!thisDB.objectStoreNames.contains(db_name)) {
                thisDB.createObjectStore(db_name);
            }
        };
        openRequest.onsuccess = function (e) {
            console.log("running onsuccess");
            db = e.target.result;
            var transaction = db.transaction([db_name], "readwrite");
            var store = transaction.objectStore(db_name);

            //Perform the add
            var request = store.add(jsonData, 1);

            request.onerror = function (e) {
                alert("Error", e.target.error.name);
            };

            request.onsuccess = function (e) {
                console.log("Woot! Did it");
                $('.bottomButtons').show();
            };
        };
        openRequest.onerror = function (e) {
            //Do something for the error
        };
    }

    function setFilterContent(val) {
        var cat = [];
        var CAtHtml = "";
        $('#ContentType').val(val);
        $.each(filteredData, function (index, subArray) {
            cat.push(subArray[val]);
        });
        CAtHtml += "<tr class='FilterTd'>";
        CAtHtml += "<td class='FilterTd'><input type='checkbox' id='select_all' value='1' name='check_all'></td>";
        CAtHtml += "<td class='FilterTd'> (Select All) </td>";
        CAtHtml += "</tr>";
        $.each(_.uniq(cat), function (index, SubCat) {
            CAtHtml += "<tr class='FilterTd'>";
            CAtHtml += "<td class='FilterTd'><input type='checkbox' id='"+index+"' value='"+SubCat+"' data-filter-type='"+val+"' data-filter-value='"+SubCat+"' class='CheckBox "+val+"'></td>";
            CAtHtml += "<td class='FilterTd'>" + SubCat + "</td>";
            CAtHtml += "</tr>";
        });
        $('#filterContent').html(CAtHtml);
    }

    $(document).on('change','input[name="check_all"]',function() {
        $('.CheckBox').not(this).prop('checked', this.checked);
    });

    $(document).on('change', '.CheckBox', function () {
        var filterType = $(this).attr('data-filter-type');
        var filterVal = $(this).attr('data-filter-value');
        filteredData1 = "";
        if (filterType == "code_b_b") {
            $('.'+filterType).each(function () {
                if ($(this).is(":checked")) {
                    var filterVal1 = $(this).attr('data-filter-value');
                    filteredData1 = _.union(filteredData1, _.filter(allData, function (item) {
                        return item.code_b_b == filterVal1;
                    }));
                }
            });
        }
        if (filterType == "couleur") {
            $('.'+filterType).each(function () {
                if ($(this).is(":checked")) {
                    var filterVal1 = $(this).attr('data-filter-value');
                    filteredData1 = _.union(filteredData1, _.filter(allData, function (item) {
                        return item.couleur == filterVal1;
                    }));

                }
            });
        }
        if (filterType == "nom") {
            $('.'+filterType).each(function () {
                if ($(this).is(":checked")) {
                    var filterVal1 = $(this).attr('data-filter-value');
                    filteredData1 = _.union(filteredData1, _.filter(allData, function (item) {
                        return item.nom == filterVal1;
                    }));
                }
            });
        }
        if (filterType == "pied") {
            $('.'+filterType).each(function () {
                if ($(this).is(":checked")) {
                    var filterVal1 = $(this).attr('data-filter-value');
                    filteredData1 = _.union(filteredData1, _.filter(allData, function (item) {
                        return item.pied == filterVal1;
                    }));
                }
            });
        }
        if (filterType == "category") {
            $('.'+filterType).each(function () {
                if ($(this).is(":checked")) {
                    var filterVal1 = $(this).attr('data-filter-value');
                    filteredData1 = _.union(filteredData1, _.filter(allData, function (item) {
                        return item.category == filterVal1;
                    }));
                }
            });
        }
        tableHtml1();
    });

    function SortAsc() {
        var ColName = $('#ContentType').val();
        if(ColName == "code_b_b"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.code_b_b];
                });
        }
        if(ColName == "category"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.category];
                });
        }
        if(ColName == "couleur"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.couleur];
                });
        }
        if(ColName == "nom"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.nom];
                });
        }
        if(ColName == "pied"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.pied];
                });
        }
        tableHtml1();
    }

    function SortDsc() {
        var ColName = $('#ContentType').val();
        if(ColName == "code_b_b"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.code_b_b];
                }).reverse();
        }
        if(ColName == "category"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.category];
                }).reverse();
        }
        if(ColName == "couleur"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.couleur];
                }).reverse();
        }
        if(ColName == "nom"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.nom];
                }).reverse();
        }
        if(ColName == "pied"){
            filteredData1 = _(filteredData1).sortBy(
                function(item){
                    return [item.pied];
                }).reverse();
        }
        tableHtml1();
    }
</script>